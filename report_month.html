 <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التقرير الشهري للفحوصات الطبية</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap">
</head>
<body>
    <style>
        /* الخطوط والإعدادات الأساسية */
        :root {
            /* الألوان الرئيسية */
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            
            /* الخلفيات */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            
            /* النصوص */
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            
            /* الحدود */
            --border-color: #e2e8f0;
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            direction: rtl;
        }

        /* رأس الصفحة */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-logo {
            width: 100px;
            height: auto;
        }

        .header-center {
            text-align: center;
            flex-grow: 1;
        }

        .header-center h1 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 28px;
        }

        .header-center p {
            margin: 2px 0;
            color: var(--text-secondary);
        }

        /* خط فاصل */
        .header-divider {
            border: 0;
            height: 3px;
            background: var(--primary-color);
            margin: 15px 0 25px 0;
        }

        /* عنوان التقرير */
        .report-title {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 24px;
        }

        /* بطاقات الملخص الإحصائي */
        .stats-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .stat-card .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-card.patients .stat-value {
            color: var(--primary-color);
        }

        .stat-card.tests .stat-value {
            color: var(--warning-color);
        }

        .stat-card.revenue .stat-value {
            color: var(--success-color);
        }

        /* اختيار الشهر */
        .month-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .month-selector select, .month-selector button {
            padding: 8px 15px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            font-family: 'Cairo', sans-serif;
        }

        .month-selector select {
            min-width: 150px;
        }

        .month-selector button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .month-selector button:hover {
            background-color: #1d4ed8;
        }

        /* جدول التفاصيل اليومية */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius);
            overflow: hidden;
            direction: ltr;
            text-align: left;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .report-table th, .report-table td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .report-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .report-table tr:nth-child(even) {
            background-color: var(--bg-secondary);
        }

        .report-table tr:hover {
            background-color: rgba(37, 99, 235, 0.05);
        }

        .report-table tfoot td {
            font-weight: bold;
            background-color: rgba(16, 185, 129, 0.1);
        }

        .report-table .total-row td {
            border-top: 2px solid var(--success-color);
        }

        /* أزرار الإجراءات */
        .actions-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn.print {
            background-color: var(--primary-color);
            color: white;
        }

        .action-btn.whatsapp {
            background-color: #25D366;
            color: white;
        }

        .action-btn.excel {
            background-color: #217346;
            color: white;
        }

        .action-btn.pdf {
            background-color: #FF5722;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* تبديل اللغة */
        .language-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 5px;
        }

        .language-btn {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
        }

        .language-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* تصميم متجاوب */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .stats-container {
                flex-direction: column;
            }

            .report-table {
                display: block;
                overflow-x: auto;
            }

            .actions-container {
                flex-direction: column;
                align-items: center;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* تحسينات الطباعة */
        @media print {
            body {
                background-color: white;
                padding: 0;
                margin: 20mm;
            }

            .month-selector, .actions-container, .language-toggle {
                display: none;
            }

            .header-divider {
                height: 2px;
            }

            .report-table {
                box-shadow: none;
            }

            .report-table th {
                background-color: #f3f4f6 !important;
                color: black !important;
            }
        }
    </style>

        <div class="fixed-icons">
    <a href="dashboard.html" title="الرئيسية" class="icon-home">
        🏠
    </a>
    <a href="new_resulat_pathion.html" title="إدارة المرضى" class="icon-patients">
        🧑‍⚕️
    </a>
</div>
 <style>
/* حاوية الأيقونات الثابتة */
.fixed-icons {
    position: fixed;
    bottom: 30px;   /* المسافة من الأسفل */
    right: 0px;    /* المسافة من اليمين */
    display: flex;
    flex-direction: column;
    gap: 15px;      /* المسافة بين الأيقونات */
    z-index: 9999;  /* لضمان ظهورها فوق كل العناصر */
}

/* تنسيق الأيقونات كأزرار دائرية */
.fixed-icons a {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #112dff00, #094bf100); /* تدرج أخضر جذاب */
    color: white;
    font-size: 28px;
    border-radius: 50% 0 0 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
}

/* تأثير عند المرور */
.fixed-icons a:hover {
    transform: scale(1.15) rotate(10deg);
    box-shadow: 0 10px 20px rgba(0,0,0,0.4);
    background: linear-gradient(135deg, #0f08dc, #0b51dc);
}

/* إضافة تأثير صغير عند الضغط */
.fixed-icons a:active {
    transform: scale(0.95) rotate(-5deg);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* اختيار أيقونات مختلفة لكل رابط إذا أحببت */
.icon-home {
    background: linear-gradient(135deg, #2196F3, #0b63c9); /* أزرق */
}

.icon-home:hover {
    background: linear-gradient(135deg, #0b63c9, #2196F3);
}

.icon-patients {
    background: linear-gradient(135deg, #FF5722, #e03d10); /* برتقالي */
}

.icon-patients:hover {
    background: linear-gradient(135deg, #e03d10, #FF5722);
}
</style>

    <!-- تبديل اللغة -->
    <div class="language-toggle">
        <button class="language-btn active" onclick="changeLanguage('ar')">عربي</button>
        <button class="language-btn" onclick="changeLanguage('fr')">Français</button>
    </div>

    <!-- رأس الصفحة -->
    <div class="header">
        <img src="logo.png" alt="شعار المستشفى" class="header-logo">
        <div class="header-center">
         <h1>     LABO AL- TIBBI  </h1>
                <h3>     CABINET MEDICAL GLOBE TERRESTRE  </h3>
                <p>  Tel: +235 69 00 08 65 / 69 00 08 64      </p>
                <p>  RONDPOINT FARCHA – NDJAMENA – TCHAD      </p>
        </div>
        <img src="logo.png" alt="شعار المستشفى" class="header-logo">
    </div>

    <hr class="header-divider">

    <!-- <h2 class="report-title">التقرير الشهري - <span id="currentMonthYear"></span></h2> -->
    <h2 class="report-title">Rapport mensuel - <span id="currentMonthYear"></span></h2>


  <!-- Sélection du mois -->
<div class="month-selector">
    <select id="monthSelect">
        <option value="0">Janvier</option>
        <option value="1">Février</option>
        <option value="2">Mars</option>
        <option value="3">Avril</option>
        <option value="4">Mai</option>
        <option value="5">Juin</option>
        <option value="6">Juillet</option>
        <option value="7">Août</option>
        <option value="8">Septembre</option>
        <option value="9">Octobre</option>
        <option value="10">Novembre</option>
        <option value="11">Décembre</option>
    </select>
    <select id="yearSelect"></select>
    <button id="applyDateFilter">Afficher le rapport</button>
</div>

    <!-- الملخص الإحصائي -->
<div class="stats-container">
    <div class="stat-card patients">
        <h3>Nombre total de patients</h3>
        <div class="stat-value" id="totalPatients">0</div>
    </div>
    <div class="stat-card tests">
        <h3>Nombre total de tests</h3>
        <div class="stat-value" id="totalTests">0</div>
    </div>
    <div class="stat-card revenue">
        <h3>Revenu total</h3>
        <div class="stat-value" id="totalRevenue">0.00 XAF</div>
    </div>
</div>


    <!-- جدول التفاصيل اليومية -->
    <table class="report-table">
        <thead>
          <tr>
    <th>Date</th>
    <th>Jour</th>
    <th>Nombre de patients</th>
    <th>Nombre de tests</th>
    <th>Montant total (XAF)</th>
</tr>

        </thead>
        <tbody id="reportTableBody">
            <!-- سيتم ملء البيانات ديناميكياً -->
        </tbody>
        <tfoot>
            <tr class="total-row">
                <!-- <td colspan="2" style="text-align: left; font-weight: bold;">إجمالي الشهر:</td> -->
                <td colspan="2" style="text-align: left; font-weight: bold;">Total du mois :</td>

                <td id="footerTotalPatients">0</td>
                <td id="footerTotalTests">0</td>
                <td id="footerTotalRevenue">0.00</td>
            </tr>
        </tfoot>
    </table>

    <!-- أزرار الإجراءات -->
    <div class="actions-container">
        <button class="action-btn print" onclick="printReport()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2H5zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1z"/>
                <path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2V7zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
            </svg>
            طباعة
            <!-- fr  -->
             imprimer
        </button>
        <button class="action-btn whatsapp" onclick="sendWhatsApp()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.55
        </button>
        <button class="action-btn whatsapp" onclick="sendWhatsApp()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
            </svg>
           
           <span>whatsapp</span>
        </button>
        <button class="action-btn excel" onclick="exportToExcel()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V9H3V2a1 1 0 0 1 1-1h5.5v2zM3 12v-2h2v2H3zm0 1h2v2H4a1 1 0 0 1-1-1v-1zm3 2v-2h3v2H6zm4 0v-2h3v1a1 1 0 0 1-1 1h-2zm3-3h-3v-2h3v2zm-7 0v-2h3v2H6z"/>
            </svg>
            <!-- fr -->
                Exporter au 
              Excel
        </button>
        <button class="action-btn pdf" onclick="exportToPDF()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                <path d="M4.603 14.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.697 19.697 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.396-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.066.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.712 5.712 0 0 1-.911-.95 11.651 11.651 0 0 0-1.997.406 11.307 11.307 0 0 1-1.02 1.51c-.292.35-.609.656-.927.787a.793.793 0 0 1-.58.029zm1.379-1.901c-.166.076-.32.156-.459.238-.328.194-.541.383-.647.547-.094.145-.096.25-.04.361.01.022.02.036.026.044a.266.266 0 0 0 .035-.012c.137-.056.355-.235.635-.572a8.18 8.18 0 0 0 .45-.606zm1.64-1.33a12.71 12.71 0 0 1 1.01-.193 11.744 11.744 0 0 1-.51-.858 20.801 20.801 0 0 1-.5 1.05zm2.446.45c.15.163.296.3.435.41.24.19.407.253.498.256a.107.107 0 0 0 .07-.015.307.307 0 0 0 .094-.125.436.436 0 0 0 .059-.2.095.095 0 0 0-.026-.063c-.052-.062-.2-.152-.518-.209a3.876 3.876 0 0 0-.612-.053zM8.078 7.8a6.7 6.7 0 0 0 .2-.828c.031-.188.043-.343.038-.465a.613.613 0 0 0-.032-.198.517.517 0 0 0-.145.04c-.087.035-.158.106-.196.283-.04.192-.03.469.046.822.024.111.054.227.09.346z"/>
            </svg>
                <!-- fr  -->
                    Exporter au
              PDF
        </button>
    </div>

    <script>
        // متغيرات عامة
        let db;
        let allResults = [];
        let currentLanguage = 'fr';
        let translations = {
            ar: {
                title: "التقرير الشهري",
                months: ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"],
                days: ["الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"],
                totalPatients: "إجمالي عدد المرضى",
                totalTests: "إجمالي عدد الفحوصات",
                totalRevenue: "إجمالي الإيرادات",
                date: "التاريخ",
                day: "اليوم",
                patients: "عدد المرضى",
                tests: "عدد الفحوصات",
                amount: "المبلغ الإجمالي (ريال)",
                monthTotal: "إجمالي الشهر:",
                print: "طباعة",
                whatsapp: "إرسال واتساب",
                excel: "تصدير Excel",
                pdf: "تصدير PDF",
                showReport: "عرض التقرير",
                currency: "ريال"
            },
            fr: {
                title: "Rapport Mensuel",
                months: ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"],
                days: ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"],
                totalPatients: "Nombre total de patients",
                totalTests: "Nombre total de tests",
                totalRevenue: "Revenu total",
                date: "Date",
                day: "Jour",
                patients: "Patients",
                tests: "Tests",
                amount: "Montant total (Riyal)",
                monthTotal: "Total du mois:",
                print: "Imprimer",
                whatsapp: "Envoyer WhatsApp",
                excel: "Exporter Excel",
                pdf: "Exporter PDF",
                showReport: "Afficher le rapport",
                currency: "Riyal"
            }
        };

        // فتح قاعدة البيانات
        const request = indexedDB.open("LabManagementDB", 1);

        request.onupgradeneeded = function(event) {
            db = event.target.result;
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            initializeDateSelectors();
            loadResults();
        };

        request.onerror = function(event) {
            console.error("خطأ في فتح قاعدة البيانات:", event.target.errorCode);
        };

        // تهيئة منتقي التاريخ
        function initializeDateSelectors() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // تعيين الشهر الحالي
            document.getElementById('monthSelect').value = currentMonth;
            
            // إنشاء قائمة السنوات (السنة الحالية و3 سنوات سابقة)
            const yearSelect = document.getElementById('yearSelect');
            for (let year = currentYear; year >= currentYear - 3; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            // تعيين السنة الحالية
            yearSelect.value = currentYear;
            
            // تحديث عنوان التقرير
            updateReportTitle();
            
            // إضافة مستمع حدث لزر تطبيق الفلتر
            document.getElementById('applyDateFilter').addEventListener('click', function() {
                updateReportTitle();
                loadResults();
            });
        }

        // تحديث عنوان التقرير
        function updateReportTitle() {
            const monthIndex = parseInt(document.getElementById('monthSelect').value);
            const year = document.getElementById('yearSelect').value;
            const monthName = translations[currentLanguage].months[monthIndex];
            document.getElementById('currentMonthYear').textContent = `${monthName} ${year}`;
        }

        // تحميل النتائج من قاعدة البيانات
        function loadResults() {
            const transaction = db.transaction(["results"], "readonly");
            const store = transaction.objectStore("results");
            const requestAll = store.getAll();
            
            requestAll.onsuccess = function() {
                allResults = requestAll.result;
                filterResultsByMonth();
            };
            
            requestAll.onerror = function(event) {
                console.error("خطأ في تحميل النتائج:", event.target.errorCode);
            };
        }

        // فلترة النتائج حسب الشهر المحدد
        function filterResultsByMonth() {
            const selectedMonth = parseInt(document.getElementById('monthSelect').value);
            const selectedYear = parseInt(document.getElementById('yearSelect').value);
            
            // فلترة النتائج حسب الشهر والسنة
            const filteredResults = allResults.filter(result => {
                const resultDate = new Date(result.date);
                return resultDate.getMonth() === selectedMonth && resultDate.getFullYear() === selectedYear;
            });
            
            // تجميع البيانات حسب اليوم
            const dailyData = {};
            
            filteredResults.forEach(result => {
                const resultDate = new Date(result.date);
                const day = resultDate.getDate();
                const dateKey = `${selectedYear}-${selectedMonth+1}-${day}`;
                
                if (!dailyData[dateKey]) {
                    dailyData[dateKey] = {
                        date: resultDate,
                        patients: 0,
                        tests: 0,
                        revenue: 0
                    };
                }
                
                dailyData[dateKey].patients++;
                
                // حساب عدد الفحوصات والإيرادات
                let testsCount = result.testsResults.length;
                let revenue = result.totalAmount;
                
                // إذا كان المبلغ الإجمالي غير محدد، نحسبه من أسعار الفحوصات
                if (revenue === undefined) {
                    revenue = 0;
                    result.testsResults.forEach(test => {
                        revenue += parseFloat(test.price || 0);
                    });
                }
                
                dailyData[dateKey].tests += testsCount;
                          dailyData[dateKey].revenue += revenue;
            });
            
            // تحويل البيانات اليومية إلى مصفوفة وترتيبها حسب التاريخ
            const sortedDailyData = Object.values(dailyData).sort((a, b) => a.date - b.date);
            
            // عرض البيانات في الجدول
            renderReportTable(sortedDailyData);
            
            // تحديث الملخص الإحصائي
            updateStatistics(sortedDailyData);
        }

        // عرض البيانات في جدول التقرير
        function renderReportTable(data) {
            const tableBody = document.getElementById('reportTableBody');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                const emptyRow = document.createElement('tr');
                const emptyCell = document.createElement('td');
                emptyCell.colSpan = 5;
                emptyCell.textContent = currentLanguage === 'ar' ? 'لا توجد بيانات لهذا الشهر' : 'Pas de données pour ce mois';
                emptyCell.style.textAlign = 'center';
                emptyCell.style.padding = '30px';
                emptyRow.appendChild(emptyCell);
                tableBody.appendChild(emptyRow);
                
                // تصفير الإحصائيات
                document.getElementById('totalPatients').textContent = '0';
                document.getElementById('totalTests').textContent = '0';
                document.getElementById('totalRevenue').textContent = `0.00 ${translations[currentLanguage].currency}`;
                document.getElementById('footerTotalPatients').textContent = '0';
                document.getElementById('footerTotalTests').textContent = '0';
                document.getElementById('footerTotalRevenue').textContent = '0.00';
                
                return;
            }
            
            // إنشاء صفوف الجدول
            data.forEach(dayData => {
                const row = document.createElement('tr');
                
                // خلية التاريخ
                const dateCell = document.createElement('td');
                const formattedDate = `${dayData.date.getDate()}/${dayData.date.getMonth() + 1}/${dayData.date.getFullYear()}`;
                dateCell.textContent = formattedDate;
                row.appendChild(dateCell);
                
                // خلية اليوم
                const dayCell = document.createElement('td');
                const dayName = translations[currentLanguage].days[dayData.date.getDay()];
                dayCell.textContent = dayName;
                row.appendChild(dayCell);
                
                // خلية عدد المرضى
                const patientsCell = document.createElement('td');
                patientsCell.textContent = dayData.patients;
                row.appendChild(patientsCell);
                
                // خلية عدد الفحوصات
                const testsCell = document.createElement('td');
                testsCell.textContent = dayData.tests;
                row.appendChild(testsCell);
                
                // خلية المبلغ الإجمالي
                const revenueCell = document.createElement('td');
                revenueCell.textContent = dayData.revenue.toFixed(2);
                row.appendChild(revenueCell);
                
                tableBody.appendChild(row);
            });
        }

        // تحديث الملخص الإحصائي
        function updateStatistics(data) {
            let totalPatients = 0;
            let totalTests = 0;
            let totalRevenue = 0;
            
            data.forEach(dayData => {
                totalPatients += dayData.patients;
                totalTests += dayData.tests;
                totalRevenue += dayData.revenue;
            });
            
            // تحديث بطاقات الإحصائيات
            document.getElementById('totalPatients').textContent = totalPatients;
            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('totalRevenue').textContent = `${totalRevenue.toFixed(2)} ${translations[currentLanguage].currency}`;
            
            // تحديث إجماليات الجدول
            document.getElementById('footerTotalPatients').textContent = totalPatients;
            document.getElementById('footerTotalTests').textContent = totalTests;
            document.getElementById('footerTotalRevenue').textContent = totalRevenue.toFixed(2);
        }

        // تغيير اللغة
        function changeLanguage(lang) {
            currentLanguage = lang;
            
            // تحديث الواجهة
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            // تحديث أزرار اللغة
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.language-btn[onclick="changeLanguage('${lang}')"]`).classList.add('active');
            
            // تحديث العناوين والنصوص
            document.querySelector('.report-title').textContent = `${translations[lang].title} - `;
            document.getElementById('currentMonthYear').textContent = `${translations[lang].months[parseInt(document.getElementById('monthSelect').value)]} ${document.getElementById('yearSelect').value}`;
            
            // تحديث عناوين البطاقات الإحصائية
            document.querySelector('.stat-card.patients h3').textContent = translations[lang].totalPatients;
            document.querySelector('.stat-card.tests h3').textContent = translations[lang].totalTests;
            document.querySelector('.stat-card.revenue h3').textContent = translations[lang].totalRevenue;
            
            // تحديث عناوين الجدول
            const tableHeaders = document.querySelectorAll('.report-table th');
            tableHeaders[0].textContent = translations[lang].date;
            tableHeaders[1].textContent = translations[lang].day;
            tableHeaders[2].textContent = translations[lang].patients;
            tableHeaders[3].textContent = translations[lang].tests;
            tableHeaders[4].textContent = translations[lang].amount;
            
            // تحديث نص إجمالي الشهر
            document.querySelector('.total-row td:first-child').textContent = translations[lang].monthTotal;
            
            // تحديث نصوص الأزرار
            document.querySelector('.action-btn.print').textContent = translations[lang].print;
            document.querySelector('.action-btn.whatsapp').textContent = translations[lang].whatsapp;
            document.querySelector('.action-btn.excel').textContent = translations[lang].excel;
            document.querySelector('.action-btn.pdf').textContent = translations[lang].pdf;
            document.getElementById('applyDateFilter').textContent = translations[lang].showReport;
            
            // تحديث قائمة الشهور
            const monthSelect = document.getElementById('monthSelect');
            const selectedMonth = monthSelect.value;
            monthSelect.innerHTML = '';
            
            translations[lang].months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            
            monthSelect.value = selectedMonth;
            
            // إعادة تحميل البيانات
            loadResults();
        }

        // طباعة التقرير
        function printReport() {
            window.print();
        }

        // إرسال التقرير عبر واتساب
        function sendWhatsApp() {
            const monthName = translations[currentLanguage].months[parseInt(document.getElementById('monthSelect').value)];
            const year = document.getElementById('yearSelect').value;
            const totalPatients = document.getElementById('totalPatients').textContent;
            const totalTests = document.getElementById('totalTests').textContent;
            const totalRevenue = document.getElementById('totalRevenue').textContent;
            
            const message = currentLanguage === 'ar' 
                ? `تقرير شهر ${monthName} ${year}%0A` +
                  `إجمالي المرضى: ${totalPatients}%0A` +
                  `إجمالي الفحوصات: ${totalTests}%0A` +
                  `إجمالي الإيرادات: ${totalRevenue}`
                : `Rapport du mois ${monthName} ${year}%0A` +
                  `Total patients: ${totalPatients}%0A` +
                  `Total tests: ${totalTests}%0A` +
                  `Total revenus: ${totalRevenue}`;
            
            window.open(`https://wa.me/?text=${message}`, '_blank');
        }

        // تصدير التقرير إلى Excel
        function exportToExcel() {
            const monthName = translations[currentLanguage].months[parseInt(document.getElementById('monthSelect').value)];
            const year = document.getElementById('yearSelect').value;
            const fileName = `${currentLanguage === 'ar' ? 'تقرير_شهر' : 'Rapport_Mois'}_${monthName}_${year}.xlsx`;
            
            // إنشاء جدول بيانات Excel
            const wb = XLSX.utils.book_new();
            
            // تحويل جدول HTML إلى ورقة عمل Excel
            const table = document.querySelector('.report-table');
            const ws = XLSX.utils.table_to_sheet(table);
            
            // إضافة ورقة العمل إلى الكتاب
            XLSX.utils.book_append_sheet(wb, ws, currentLanguage === 'ar' ? 'تقرير شهري' : 'Rapport Mensuel');
            
            // تنزيل الملف
            XLSX.writeFile(wb, fileName);
        }

        // تصدير التقرير إلى PDF
        function exportToPDF() {
            const monthName = translations[currentLanguage].months[parseInt(document.getElementById('monthSelect').value)];
            const year = document.getElementById('yearSelect').value;
            const fileName = `${currentLanguage === 'ar' ? 'تقرير_شهر' : 'Rapport_Mois'}_${monthName}_${year}.pdf`;
            
            // إعدادات PDF
            const element = document.body;
            const opt = {
                margin: 10,
                filename: fileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            // إخفاء العناصر غير المطلوبة للطباعة
            const actionsContainer = document.querySelector('.actions-container');
            const monthSelector = document.querySelector('.month-selector');
            const languageToggle = document.querySelector('.language-toggle');
            
            actionsContainer.style.display = 'none';
            monthSelector.style.display = 'none';
            languageToggle.style.display = 'none';
            
            // إنشاء PDF
            html2pdf().from(element).set(opt).save().then(() => {
                // إعادة عرض العناصر المخفية
                actionsContainer.style.display = 'flex';
                monthSelector.style.display = 'flex';
                languageToggle.style.display = 'flex';
            });
        }

        // إضافة مكتبات خارجية للتصدير
        function loadExternalLibraries() {
            // إضافة مكتبة XLSX لتصدير Excel
            const xlsxScript = document.createElement('script');
            xlsxScript.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
            document.head.appendChild(xlsxScript);
            
            // إضافة مكتبة html2pdf لتصدير PDF
            const html2pdfScript = document.createElement('script');
            html2pdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
            document.head.appendChild(html2pdfScript);
        }

        // تحميل المكتبات الخارجية عند تحميل الصفحة
        window.addEventListener('load', loadExternalLibraries);
    </script>
</body>
</html>

