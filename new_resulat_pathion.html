<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<style>
    /* Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');

    :root {
        /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        --primary-color: #2563eb;
        --secondary-color: #64748b;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        
        /* Ø§Ù„Ø®Ù„ÙÙŠØ§Øª */
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        
        /* Ø§Ù„Ù†ØµÙˆØµ */
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        
        /* Ø§Ù„Ø­Ø¯ÙˆØ¯ */
        --border-color: #e2e8f0;
        --border-radius: 8px;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Cairo', sans-serif;
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        line-height: 1.6;
        padding: 20px;
        direction: rtl;
        text-align: right;
    }

    /* Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
    h1, h2 {
        color: var(--primary-color);
        margin-bottom: 20px;
        text-align: center;
    }

    h1 {
        font-size: 2rem;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
        margin-bottom: 30px;
    }

    h2 {
        font-size: 1.5rem;
        margin-top: 30px;
    }

    /* Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    form {
        background-color: var(--bg-primary);
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-group {
        flex: 1;
        min-width: 200px;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--text-primary);
    }

    input, select {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        font-family: 'Cairo', sans-serif;
        font-size: 1rem;
    }

    input:focus, select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    button {
        cursor: pointer;
        font-family: 'Cairo', sans-serif;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: var(--border-radius);
        font-size: 1rem;
    }

    .btn:hover {
        background-color: #1d4ed8;
        transform: translateY(-2px);
    }

    .btn-success {
        background-color: var(--success-color);
    }

    .btn-success:hover {
        background-color: #059669;
    }

    .btn-add {
        display: block;
        margin: 20px auto;
        padding: 8px 20px;
    }

    #saveBtn {
        width: 100%;
        margin-top: 20px;
        padding: 12px;
    }

    /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ­ÙˆØµØ§Øª */
    table {
        width: 100%;
        border-collapse: collapse;
        background-color: var(--bg-primary);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
    }

    th, td {
        padding: 12px 15px;
        text-align: right;
    }

    th {
        background-color: var(--primary-color);
        color: white;
        font-weight: 600;
    }

    tr:nth-child(even) {
        background-color: var(--bg-secondary);
    }

    tr:hover {
        background-color: rgba(37, 99, 235, 0.05);
    }

    td button {
        background-color: var(--secondary-color);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: var(--border-radius);
        font-size: 0.9rem;
        margin: 0 2px;
    }

    td button.btn-edit {
        background-color: var(--warning-color);
    }

    td button.btn-edit:hover {
        background-color: #d97706;
    }

    td button.btn-delete {
        background-color: var(--danger-color);
    }

    td button.btn-delete:hover {
        background-color: #dc2626;
    }

    td button.btn-view {
        background-color: var(--primary-color);
    }

    td button.btn-view:hover {
        background-color: #1d4ed8;
    }

    td button.btn-print {
        background-color: var(--secondary-color);
    }

    td button.btn-print:hover {
        background-color: #475569;
    }

    /* Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ÙØ­ÙˆØµØ§Øª */
    tr td[colspan] {
        text-align: center;
        padding: 20px;
        color: var(--text-secondary);
        font-style: italic;
    }

    /* ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ */
    @media (max-width: 768px) {
        table {
            display: block;
            overflow-x: auto;
        }
        
        form {
            padding: 15px;
        }
        
        h1 {
            font-size: 1.8rem;
        }
        
        h2 {
            font-size: 1.3rem;
        }

        .form-row {
            flex-direction: column;
            gap: 0;
        }
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .alert {
        padding: 10px;
        border-radius: var(--border-radius);
        margin-bottom: 15px;
        text-align: center;
    }

    .alert-success {
        background-color: rgba(16, 185, 129, 0.2);
        color: var(--success-color);
        border: 1px solid var(--success-color);
    }

    .alert-error {
        background-color: rgba(239, 68, 68, 0.2);
        color: var(--danger-color);
        border: 1px solid var(--danger-color);
    }

    .hidden {
        display: none;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ ØµÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ */
    .total-row {
        background-color: rgba(16, 185, 129, 0.1);
        font-weight: bold;
    }

    .total-row td {
        border-top: 2px solid var(--success-color);
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚Ù„ Ø§Ù„Ø³Ø¹Ø± */
    .price-field {
        font-weight: bold;
        color: var(--success-color);
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ */
    .total-amount {
        font-weight: bold;
        color: var(--success-color);
        font-size: 1.1em;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
    .details-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: var(--bg-primary);
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
    }

    .details-modal h3 {
        color: var(--primary-color);
        margin-bottom: 15px;
        text-align: center;
    }

    .details-modal button {
        margin-top: 15px;
        margin-left: 5px;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø« */
    .filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
        background-color: var(--bg-primary);
        padding: 15px;
        border-radius: var(--border-radius);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .filter-container input, .filter-container button {
        margin: 0;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø© */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }
</style>
<body>
    <div class="fixed-icons">
    <a href="dashboard.html" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" class="icon-home">
        ğŸ 
    </a>
    <a href="new_resulat_pathion.html" title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰" class="icon-patients">
        ğŸ§‘â€âš•ï¸
    </a>
</div>
<style>
/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© */
.fixed-icons {
    position: fixed;
    bottom: 30px;   /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ */
    right: 30px;    /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
    display: flex;
    flex-direction: column;
    gap: 15px;      /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
    z-index: 9999;  /* Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙˆÙ‚ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙƒØ£Ø²Ø±Ø§Ø± Ø¯Ø§Ø¦Ø±ÙŠØ© */
.fixed-icons a {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #4CAF50, #087f23); /* ØªØ¯Ø±Ø¬ Ø£Ø®Ø¶Ø± Ø¬Ø°Ø§Ø¨ */
    color: white;
    font-size: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
}

/* ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± */
.fixed-icons a:hover {
    transform: scale(1.15) rotate(10deg);
    box-shadow: 0 10px 20px rgba(0,0,0,0.4);
    background: linear-gradient(135deg, #087f23, #4CAF50);
}

/* Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± ØµØºÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
.fixed-icons a:active {
    transform: scale(0.95) rotate(-5deg);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ø®ØªÙ„ÙØ© Ù„ÙƒÙ„ Ø±Ø§Ø¨Ø· Ø¥Ø°Ø§ Ø£Ø­Ø¨Ø¨Øª */
.icon-home {
    background: linear-gradient(135deg, #2196F3, #0b63c9); /* Ø£Ø²Ø±Ù‚ */
}

.icon-home:hover {
    background: linear-gradient(135deg, #0b63c9, #2196F3);
}

.icon-patients {
    background: linear-gradient(135deg, #FF5722, #e03d10); /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
}

.icon-patients:hover {
    background: linear-gradient(135deg, #e03d10, #FF5722);
}
</style>

    <div class="container">
        <h1>Ø¥Ø¯Ø§Ø±Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</h1>

        <div id="alertContainer" class="hidden"></div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ -->
        <form id="patientForm">
            <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="patientName">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</label>
                    <input type="text" id="patientName" required>
                </div>
                <div class="form-group">
                    <label for="patientAge">Ø§Ù„Ø¹Ù…Ø±:</label>
                    <input type="number" id="patientAge" min="0" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="patientGender">Ø§Ù„Ø¬Ù†Ø³:</label>
                    <select id="patientGender" required>
                        <option value="">-- Ø§Ø®ØªØ± --</option>
                        <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                        <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="patientID">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù:</label>
                    <input type="text" id="patientID" required>
                </div>
            </div>

            <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª</h2>
            <table id="testsTable">
                <thead>
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„ÙØ­Øµ</th>
                        <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                        <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©</th>
                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody >
                    <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙÙˆÙ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="4" style="text-align: left; font-weight: bold;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td>
                        <td id="totalAmount" class="total-amount">0.00 Ø±ÙŠØ§Ù„</td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
                </table>

            <button type="button" id="addTestBtn" class="btn btn-add">+ Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ</button>
            <button type="submit" id="saveBtn" class="btn btn-success">Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
        </form>

        <h2>Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª</h2>
        
        <!-- ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø« -->
        <div class="filter-container">
            <input type="text" id="patientFilter" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" oninput="filterResults()">
            <input type="date" id="dateFilter" onchange="filterResults()">
            <button onclick="resetFilters()" class="btn">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„ØªØ±</button>
        </div>
        
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</th>
                    <th>Ø§Ù„Ø¹Ù…Ø±</th>
                    <th>Ø§Ù„Ø¬Ù†Ø³</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù</th>
                    <th>Ø¹Ø¯Ø¯ Ø§Ù„ÙØ­ÙˆØµØ§Øª</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="resultsTableBody">
                <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ -->
            </tbody>
        </table>
                            <div class="pagination-controls" id="paginationControls" style="margin-top:10px; text-align:center;"></div>
    </div>
 <style>
    /* Ø­Ø§ÙˆÙŠØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª */
.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin: 20px 0;
    flex-wrap: wrap;
}

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© */
.pagination-controls button {
    padding: 8px 16px;
    border: none;
    background: linear-gradient(145deg, #4f46e5, #2563eb);
    color: #ffffff;
    font-weight: 600;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    transition: all 0.25s ease-in-out;
}

/* ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø§ÙˆØ³ */
.pagination-controls button:hover:not(:disabled) {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 6px 10px rgba(0,0,0,0.2);
    background: linear-gradient(145deg, #6b5dd1, #3b82f6);
}

/* Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø· */
.pagination-controls button.active {
    background: linear-gradient(145deg, #2563eb, #1d4ed8);
    box-shadow: 0 4px 8px rgba(0,0,0,0.25);
    cursor: default;
    pointer-events: none;
    transform: scale(1.05);
}

/* Ø²Ø± ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ù‚Ø± */
.pagination-controls button:disabled {
    background: #d1d5db;
    color: #9ca3af;
    box-shadow: none;
    cursor: not-allowed;
}

 </style>
    <script>
        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let db;
        let editingId = null;
        const patientForm = document.getElementById("patientForm");
        const testsTableBody = document.querySelector("#testsTable tbody");
        const resultsTableBody = document.querySelector("#resultsTable tbody");
        const addTestBtn = document.getElementById("addTestBtn");
        const alertContainer = document.getElementById("alertContainer");
        const totalAmountElement = document.getElementById("totalAmount");

        // ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const request = indexedDB.open("LabManagementDB", 1);

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø®Ø²Ù† Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if(!db.objectStoreNames.contains("tests")) {
                const testsStore = db.createObjectStore("tests", { keyPath: "id", autoIncrement: true });
                testsStore.createIndex("name", "name", { unique: true });
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø®Ø²Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if(!db.objectStoreNames.contains("results")) {
                const resultsStore = db.createObjectStore("results", { keyPath: "id", autoIncrement: true });
                resultsStore.createIndex("patientID", "patientID", { unique: false });
                resultsStore.createIndex("date", "date", { unique: false });
            }
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            loadResults();
            addInitialTestRow();
        };

        request.onerror = function(event) {
            showAlert("Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + event.target.errorCode, "error");
        };

        // Ø¥Ø¶Ø§ÙØ© ØµÙ ÙØ­Øµ Ø¬Ø¯ÙŠØ¯
        addTestBtn.addEventListener("click", function() {
            addTestRow();
        });

        // Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù†Ø¯ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        patientForm.addEventListener("submit", function(e) {
            e.preventDefault();
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŸ")) {
                saveResults();
            }
        });

        // Ø¥Ø¶Ø§ÙØ© ØµÙ ÙØ­Øµ Ø£ÙˆÙ„ÙŠ
        function addInitialTestRow() {
            if (testsTableBody.children.length === 0) {
                addTestRow();
            }
        }

        // Ø¥Ø¶Ø§ÙØ© ØµÙ ÙØ­Øµ Ø¬Ø¯ÙŠØ¯
        function addTestRow(testData = null) {
            const row = document.createElement("tr");
            const rowIndex = testsTableBody.children.length;
            
            row.innerHTML = `
                <td>
                    <select name="test_name[]" required onchange="updateTestDetails(this, ${rowIndex})">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙØ­Øµ --</option>
                        <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                    </select>
                </td>
                <td>
                    <select name="result[]" required>

                        <option value="">-- Ø§Ø®ØªØ± --</option>
                        
                          <option value="00 g/l">00 g/l</option> 
    <option value="01 g/l">01 g/l</option> 
    <option value="02 g/l">02 g/l</option> 
    <option value="03 g/l">03 g/l</option> 
    <option value="0.4 g/l">0.4 g/l</option> 
    <option value="0.5 g/l">0.5 g/l</option> 
    <option value="0.55 g/l">0.55 g/l</option> 
    <option value="0.56 g/l">0.56 g/l</option> 
    <option value="0.57 g/l">0.57 g/l</option> 
    <option value="0.58 g/l">0.58 g/l</option> 
    <option value="0.59 g/l">0.59 g/l</option> 
    <option value="0.60 g/l">0.60 g/l</option> 
    <option value="0.61 g/l">0.61 g/l</option> 
    <option value="0.62 g/l">0.62 g/l</option> 
    <option value="0.63 g/l">0.63 g/l</option> 
    <option value="0.64 g/l">0.64 g/l</option> 
    <option value="0.65 g/l">0.65 g/l</option> 
    <option value="0.66 g/l">0.66 g/l</option> 
    <option value="0.67 g/l">0.67 g/l</option> 
    <option value="0.68 g/l">0.68 g/l</option> 
    <option value="0.69 g/l">0.69 g/l</option> 
    <option value="0.70 g/l">0.70 g/l</option> 
    <option value="0.71 g/l">0.71 g/l</option> 
    <option value="0.72 g/l">0.72 g/l</option> 
    <option value="0.73 g/l">0.73 g/l</option> 
    <option value="0.74 g/l">0.74 g/l</option> 
    <option value="0.75 g/l">0.75 g/l</option> 
    <option value="0.76 g/l">0.76 g/l</option> 
    <option value="0.77 g/l">0.77 g/l</option> 
    <option value="0.78 g/l">0.78 g/l</option> 
    <option value="0.79 g/l">0.79 g/l</option> 
    <option value="0.80 g/l">0.80 g/l</option> 
    <option value="0.81 g/l">0.81 g/l</option> 
    <option value="0.82 g/l">0.82 g/l</option> 
    <option value="0.83 g/l">0.83 g/l</option> 
    <option value="0.84 g/l">0.84 g/l</option> 
    <option value="0.85 g/l">0.85 g/l</option> 
    <option value="0.86 g/l">0.86 g/l</option> 
    <option value="0.87 g/l">0.87 g/l</option> 
    <option value="0.88 g/l">0.88 g/l</option> 
    <option value="0.89 g/l">0.89 g/l</option> 
    <option value="0.90 g/l">0.90 g/l</option> 
    <option value="0.91 g/l">0.91 g/l</option> 
    <option value="0.92 g/l">0.92 g/l</option> 
    <option value="0.93 g/l">0.93 g/l</option> 
    <option value="0.94 g/l">0.94 g/l</option> 
    <option value="0.95 g/l">0.95 g/l</option> 
    <option value="0.97 g/l">0.97 g/l</option> 
    <option value="0.98 g/l">0.98 g/l</option> 
    <option value="0.99 g/l">0.99 g/l</option> 
    <option value="1.00 g/l">1.00 g/l</option> 
    <option value="1.01 g/l">1.01 g/l</option> 
    <option value="1.02 g/l">1.02 g/l</option> 
    <option value="1.03 g/l">1.03 g/l</option> 
    <option value="1.04 g/l">1.04 g/l</option> 
    <option value="1.05 g/l">1.05 g/l</option> 
    <option value="1.06 g/l">1.06 g/l</option> 
    <option value="1.07 g/l">1.07 g/l</option> 
    <option value="1.08 g/l">1.08 g/l</option> 
    <option value="1.09 g/l">1.09 g/l</option> 
    <option value="1.10 g/l">1.10 g/l</option> 
    <option value="1.11 g/l">1.11 g/l</option> 
    <option value="1.12 g/l">1.12 g/l</option> 
    <option value="1.13 g/l">1.13 g/l</option> 
    <option value="1.14 g/l">1.14 g/l</option> 
    <option value="1.15 g/l">1.15 g/l</option> 
    <option value="1.16 g/l">1.16 g/l</option> 
    <option value="1.17 g/l">1.17 g/l</option> 
    <option value="1.18 g/l">1.18 g/l</option> 
    <option value="1.19 g/l">1.19 g/l</option> 
    <option value="1.20 g/l">1.20 g/l</option> 
    <option value="1.21 g/l">1.21 g/l</option> 
    <option value="1.22 g/l">1.22 g/l</option> 
    <option value="1.23 g/l">1.23 g/l</option> 
    <option value="1.24 g/l">1.24 g/l</option> 
    <option value="1.25 g/l">1.25 g/l</option> 
    <option value="1.26 g/l">1.26 g/l</option> 
    <option value="1.27 g/l">1.27 g/l</option> 
    <option value="1.28 g/l">1.28 g/l</option> 
    <option value="1.29 g/l">1.29 g/l</option> 
    <option value="1.30 g/l">1.30 g/l</option> 
    <option value="1.31 g/l">1.31 g/l</option> 
    <option value="1.32 g/l">1.32 g/l</option> 
    <option value="1.33 g/l">1.33 g/l</option> 
    <option value="1.34 g/l">1.34 g/l</option> 
    <option value="1.35 g/l">1.35 g/l</option> 
    <option value="1.36 g/l">1.36 g/l</option> 
    <option value="1.37 g/l">1.37 g/l</option> 
    <option value="1.38 g/l">1.38 g/l</option> 
    <option value="1.39 g/l">1.39 g/l</option> 
    <option value="1.40 g/l">1.40 g/l</option> 
    <option value="1.41 g/l">1.41 g/l</option> 
    <option value="1.42 g/l">1.42 g/l</option> 
    <option value="1.43 g/l">1.43 g/l</option> 
    <option value="1.44 g/l">1.44 g/l</option> 
    <option value="1.45 g/l">1.45 g/l</option> 
    <option value="1.46 g/l">1.46 g/l</option> 
    <option value="1.47 g/l">1.47 g/l</option> 
    <option value="1.48 g/l">1.48 g/l</option> 
    <option value="1.49 g/l">1.49 g/l</option> 
    <option value="1.50 g/l">1.50 g/l</option> 
    <option value="1.51 g/l">1.51 g/l</option> 
    <option value="1.52 g/l">1.52 g/l</option> 
    <option value="1.53 g/l">1.53 g/l</option> 
    <option value="1.54 g/l">1.54 g/l</option> 
    <option value="1.55 g/l">1.55 g/l</option> 
    <option value="1.56 g/l">1.56 g/l</option> 

    <option value="voir la fiche">voir la fiche</option> 
    <option value="++ ve (14 TPF /100 CHAMPS ) Densite moyenne">++ ve (14 TPF /100 CHAMPS ) Densite moyenne</option> 
    <option value="++ ve (14 TPF /100 CHAMPS ) Densite Faible">++ ve (14 TPF /100 CHAMPS ) Densite Faible</option> 
    <option value="++ ve (14 TPF /100 CHAMPS ) Densite Forte">++ ve (14 TPF /100 CHAMPS ) Densite Forte</option> 
    <option value="++ ve (14 TPF /100 CHAMPS ) Densite elevee">++ ve (14 TPF /100 CHAMPS ) Densite elevee</option> 
    <option value="reaction positive(+)">reaction positive(+)</option> 
    <option value="1.60 g/l">1.60 g/l</option> 
    <option value="1.61 g/l">1.61 g/l</option> 
    <option value="1.62 g/l">1.62 g/l</option> 
    <option value="1.63 g/l">1.63 g/l</option> 
    <option value="1.64 g/l">1.64 g/l</option> 
    <option value="1.65 g/l">1.65 g/l</option> 
    <option value="1.66 g/l">1.66 g/l</option> 
    <option value="Test positif (+)">Test positif (+)</option> 
    <option value="Test nÃ©gatif au dÃ©termine HIV 1/2 (âˆ’)">Test nÃ©gatif au dÃ©termine HIV 1/2 (âˆ’)</option> 
    <option value="5.05 ng/ml">5.05 ng/ml</option> 
    <option value="GS=O Rh positif(O+)">GS=O Rh positif(O+)</option> 
    <option value="GS=O Rh negatif(Oâˆ’)">GS=O Rh negatif(Oâˆ’)</option> 
    <option value="GS=A Rh= positif(A+)">GS=A Rh= positif(A+)</option> 
    <option value="GS=A Rh negatif (Aâˆ’)">GS=A Rh negatif (Aâˆ’)</option> 
    <option value="GS= B Rh= positif(B+)">GS= B Rh= positif(B+)</option> 
    <option value="GS= B Rh= nÃ©gatif (Bâˆ’)">GS= B Rh= nÃ©gatif (Bâˆ’)</option> 
    <option value="GS=AB Rh= positif (AB+)">GS=AB Rh= positif (AB+)</option> 
    <option value="Gs=AB Rh negatif(ABâˆ’)">Gs=AB Rh negatif(ABâˆ’)</option> 
    <option value="LEU- NIT- URO- PRO- PH6 BLD- SG 1.030 KET- BIL- GLU-">LEU- NIT- URO- PRO- PH6 BLD- SG 1.030 KET- BIL- GLU-</option> 
    <option value="test nÃ©gatif Ã  l'AgHBS (âˆ’)">test nÃ©gatif Ã  l'AgHBS (âˆ’)</option> 
    <option value="test nÃ©gatif au BW(âˆ’)">test nÃ©gatif au BW(âˆ’)</option> 
    <option value="test nÃ©gatif au HCV(âˆ’)">test nÃ©gatif au HCV(âˆ’)</option> 
    <option value="test nÃ©gatif (âˆ’)">test nÃ©gatif (âˆ’)</option> 
    <option value="test positif(+)">test positif(+)</option> 
    <option value="test positif au HCG dans le sÃ©rum (+)">test positif au HCG dans le sÃ©rum (+)</option> 
    <option value="test positif au HCG dans les urines(+)">test positif au HCG dans les urines(+)</option> 
    <option value="test nÃ©gatif au HCG dans le sÃ©rum (âˆ’)">test nÃ©gatif au HCG dans le sÃ©rum (âˆ’)</option> 
    <option value="test nÃ©gatif au HCG dans les urines (âˆ’)">test nÃ©gatif au HCG dans les urines (âˆ’)</option> 
    <option value="mm3/30min">mm3/30min</option> 
    <option value="IgM +">IgM +</option> 
    <option value="IgG +">IgG +</option> 
    <option value="%">%</option> 
                        
                    </select>
                </td>
                <td>
                      <select name="unit[]" > 
                       <option value="reference"> reference </option> 
                        </select>
                </td>
                <td>
                     
                    <select name="reference[]" > 
    <option value="">-- Choisissez un Ã©lÃ©ment  --</option> 
    <option value="0.74 aË‹ 1.06 g/l">0.74 aË‹ 1.06 g/l</option> 
    <option value="3.5 aË‹ 5.5 mmol/l">3.5 aË‹ 5.5 mmol/l</option> 
    <option value="aucune">aucune</option> 
    <option value="98 aË‹ 107 mmol/l">98 aË‹ 107 mmol/l</option> 
    <option value="2.00 aË‹ 2.39 g/l">2.00 aË‹ 2.39 g/l</option> 
    <option value="86 aË‹ 100 mg/l">86 aË‹ 100 mg/l</option> 
    <option value="135 aË‹ 155 mmol/l">135 aË‹ 155 mmol/l</option> 
    <option value="16 aË‹ 26 mg/l">16 aË‹ 26 mg/l</option> 
    <option value="0.15 aË‹ 0.45 g/l">0.15 aË‹ 0.45 g/l</option> 
    <option value="0.06 aË‹ 0.18 g/l">0.06 aË‹ 0.18 g/l</option> 
    <option value="6 aË‹ 11 mg/l">6 aË‹ 11 mg/l</option> 
    <option value="9 aË‹ 13 mg/l">9 aË‹ 13 mg/l</option> 
    <option value="<1.40 g/l">1.40 g/l</option> 
    <option value="1.61 aË‹ 8.41 ng/ml">1.61 aË‹ 8.41 ng/ml</option> 
    <option value="2 aË‹ 6 mg/dl">2 aË‹ 6 mg/dl</option> 
    <option value="3.5 aË‹ 7 mg/dl">3.5 aË‹ 7 mg/dl</option> 
    <option value="20 aË‹ 60 mg/l">20 aË‹ 60 mg/l</option> 
    <option value="35 aË‹ 70 mg/l">35 aË‹ 70 mg/l</option> 
    <option value="4 Ã  6.5%">4 Ã  6.5%</option> 
</select>
                     
                    </td>
                <td>
                    <input type="number" name="price[]" placeholder="Ø§Ù„Ø³Ø¹Ø±" min="0" step="0.01" class="price-field" oninput="updateTotalAmount()">
                </td>
                <td>
                    <input type="text" name="notes[]" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
                </td>
                <td>
                    <button type="button" class="btn-delete" onclick="removeTestRow(this)">Ø­Ø°Ù</button>
                </td>
            `;
            
            testsTableBody.appendChild(row);
            
            // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ­ÙˆØµØ§Øª ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            loadTestsIntoSelect(row.querySelector('select[name="test_name[]"]'));
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙØ­ØµØŒ Ù‚Ù… Ø¨Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„
            if (testData) {
                const selects = row.querySelectorAll('select');
                const inputs = row.querySelectorAll('input');
                
                selects[0].value = testData.testName;
                selects[1].value = testData.result;
                inputs[0].value = testData.unit || '';
                inputs[1].value = testData.reference || '';
                inputs[2].value = testData.price || '';
                inputs[3].value = testData.notes || '';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                updateTotalAmount();
            }
        }

        // Ø­Ø°Ù ØµÙ ÙØ­Øµ
        function removeTestRow(button) {
            const row = button.closest('tr');
            row.remove();
            
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ¨Ù‚ Ø£ÙŠ ØµÙÙˆÙØŒ Ø£Ø¶Ù ØµÙÙ‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§
            if (testsTableBody.children.length === 0) {
                addTestRow();
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            updateTotalAmount();
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ­ÙˆØµØ§Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        function loadTestsIntoSelect(selectElement) {
            const transaction = db.transaction(["tests"], "readonly");
            const store = transaction.objectStore("tests");
            const requestAll = store.getAll();
            
            requestAll.onsuccess = function() {
                const tests = requestAll.result;
                
                // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± ÙØ§Ø±Øº
                selectElement.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙØ­Øµ --</option>';
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ­ÙˆØµØ§Øª
                tests.forEach(test => {
                    const option = document.createElement("option");
                    option.value = test.name;
                    option.textContent = test.name;
                    option.dataset.unit = test.unit || '';
                    option.dataset.reference = test.reference || '';
                    option.dataset.price = test.price || 0;
                    selectElement.appendChild(option);
                });
            };
            
            requestAll.onerror = function(event) {
                showAlert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ­ÙˆØµØ§Øª: " + event.target.errorCode, "error");
            };
        }

        // ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ­Øµ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± ÙØ­Øµ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        function updateTestDetails(selectElement, rowIndex) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const row = selectElement.closest('tr');
            
            if (selectedOption.value) {
                const transaction = db.transaction(["tests"], "readonly");
                const store = transaction.objectStore("tests");
                const index = store.index("name");
                const request = index.get(selectedOption.value);
                
                request.onsuccess = function() {
                    const test = request.result;
                    if (test) {
                        row.querySelector('select[name="unit[]"]').value = test.unit || '';
                        row.querySelector('select[name="reference[]"]').value = test.reference || '';
                        row.querySelector('input[name="price[]"]').value = test.price || 0;
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                        updateTotalAmount();
                    }
                };
                
                request.onerror = function(event) {
                    showAlert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ­Øµ: " + event.target.errorCode, "error");
                };
            } else {
                // Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„ÙØ§Ø±ØºØŒ Ø§Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
                row.querySelector('select[name="unit[]"]').value = '';
                row.querySelector('select[name="reference[]"]').value = '';
                row.querySelector('input[name="price[]"]').value = '';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                updateTotalAmount();
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        function updateTotalAmount() {
            let total = 0;
            const priceInputs = testsTableBody.querySelectorAll('input[name="price[]"]');
            
            priceInputs.forEach(input => {
                const price = parseFloat(input.value) || 0;
                total += price;
            });
            
            totalAmountElement.textContent = total.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            return total;
        }

        // Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª
        function saveResults() {
            // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
            const patientName = document.getElementById("patientName").value.trim();
            const patientAge = parseInt(document.getElementById("patientAge").value);
            const patientGender = document.getElementById("patientGender").value;
            const patientID = document.getElementById("patientID").value.trim();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (!patientName || isNaN(patientAge) || !patientGender || !patientID) {
                showAlert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶", "error");
                return;
            }
            
            // Ø¬Ù…Ø¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª
            const testRows = testsTableBody.querySelectorAll('tr');
            const testsResults = [];
            let totalAmount = 0;
            
            for (let i = 0; i < testRows.length; i++) {
                const row = testRows[i];
                const testName = row.querySelector('select[name="test_name[]"]').value;
                const result = row.querySelector('select[name="result[]"]').value;
                const unit = row.querySelector('select[name="unit[]"]').value;
                const reference = row.querySelector('select[name="reference[]"]').value;
                
                const price = parseFloat(row.querySelector('input[name="price[]"]').value) || 0;
                const notes = row.querySelector('input[name="notes[]"]').value;
                
                if (!testName || !result) {
                    showAlert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ø³Ù… Ø§Ù„ÙØ­Øµ ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ­ÙˆØµØ§Øª", "error");
                    return;
                }
                
                if (isNaN(price) || price < 0) {
                    showAlert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ØµØ­ÙŠØ­ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ­ÙˆØµØ§Øª", "error");
                    return;
                }
                
                totalAmount += price;
                
                testsResults.push({
                    testName,
                    result,
                    unit,
                    reference,
                    price,
                    notes
                });
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            const resultData = {
                patientName,
                patientAge,
                patientGender,
                patientID,
                testsResults,
                totalAmount,
                date: new Date().toISOString()
            };
            
            // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø£Ø¶Ù Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„
            if (editingId !== null) {
                resultData.id = editingId;
            }
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const transaction = db.transaction(["results"], "readwrite");
            const store = transaction.objectStore("results");
            
            let request;
            if (editingId !== null) {
                request = store.put(resultData);
            } else {
                request = store.add(resultData);
            }
            
            request.onsuccess = function() {
                showAlert(`ØªÙ… ${editingId !== null ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ø­ÙØ¸'} Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ù†Ø¬Ø§Ø­!`, "success");
                patientForm.reset();
                testsTableBody.innerHTML = '';
                addInitialTestRow();
                loadResults();
                editingId = null;
                totalAmountElement.textContent = "0.00 Ø±ÙŠØ§Ù„";
            };
            
            request.onerror = function(event) {
                showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: " + event.target.errorCode, "error");
            };
        }

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        let allResults = [];       // Ù„ØªØ®Ø²ÙŠÙ† ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
let currentPage = 1;       // Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
const rowsPerPage = 250;   

const tableBody = document.getElementById("resultsTableBody");
const paginationDiv = document.getElementById("paginationControls");

function loadResults() {
    const transaction = db.transaction(["results"], "readonly");
    const store = transaction.objectStore("results");
    const requestAll = store.getAll();

    requestAll.onsuccess = function() {
        allResults = requestAll.result;

        if (allResults.length === 0) {
            tableBody.innerHTML = "<tr><td colspan='8'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø­ÙÙˆØ¸Ø©.</td></tr>";
            paginationDiv.innerHTML = "";
            return;
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
        allResults.sort((a, b) => new Date(b.date) - new Date(a.date));

        currentPage = 1; // Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
        renderTable();
        renderPagination();
    };

    requestAll.onerror = function(event) {
        showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: " + event.target.errorCode, "error");
    };
}

// Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
function renderTable() {
    tableBody.innerHTML = "";

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const slice = allResults.slice(start, end);

    slice.forEach(result => {
        const date = new Date(result.date);
        const formattedDate = formatDate(date);

        let totalAmount = result.totalAmount;
        if (totalAmount === undefined) {
            totalAmount = 0;
            result.testsResults.forEach(test => {
                totalAmount += parseFloat(test.price || 0);
            });
        }

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${result.patientName}</td>
            <td>${result.patientAge}</td>
            <td>${result.patientGender}</td>
            <td>${result.patientID}</td>
            <td>${result.testsResults.length}</td>
            <td class="total-amount">${totalAmount.toFixed(2)}</td>
            <td>${formattedDate}</td>
            <td>
                <button class="btn-edit"  onclick="editResult(${result.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn-delete" onclick="deleteResult(${result.id})">Ø­Ø°Ù</button>
                <button class="btn-view" onclick="viewResultDetails(${result.id})">Ø¹Ø±Ø¶</button>
                <button class="btn-print" onclick="printResultDetails(${result.id})">Ø·Ø¨Ø§Ø¹Ø©</button>
            </td>
        `;
        tableBody.appendChild(row);
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„ØµÙØ­Ø©
    const pageTotal = slice.reduce((sum, r) => {
        let total = r.totalAmount;
        if (total === undefined) {
            total = 0;
            r.testsResults.forEach(test => { total += parseFloat(test.price || 0); });
        }
        return sum + total;
    }, 0);
    document.getElementById("totalAmount").textContent = pageTotal.toFixed(2) + " Ø±ÙŠØ§Ù„";
}

// Ø±Ø³Ù… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª
function renderPagination() {
    paginationDiv.innerHTML = "";
    const totalPages = Math.ceil(allResults.length / rowsPerPage);

    // Ø²Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
    const prevBtn = document.createElement("button");
    prevBtn.textContent = "Ø§Ù„Ø³Ø§Ø¨Ù‚";
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => { currentPage--; renderTable(); renderPagination(); };
    paginationDiv.appendChild(prevBtn);

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.style.fontWeight = i === currentPage ? "bold" : "normal";
        btn.onclick = () => { currentPage = i; renderTable(); renderPagination(); };
        paginationDiv.appendChild(btn);
    }

    // Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ
    const nextBtn = document.createElement("button");
    nextBtn.textContent = "Ø§Ù„ØªØ§Ù„ÙŠ";
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => { currentPage++; renderTable(); renderPagination(); };
    paginationDiv.appendChild(nextBtn);
}

// Ù…Ø«Ø§Ù„ Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
function formatDate(date) {
    return date.toLocaleDateString() + " " + date.toLocaleTimeString();
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadResults();
        // ØªØ¹Ø¯ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ù…Ø­ÙÙˆØ¸Ø©
        function editResult(id) {
            const transaction = db.transaction(["results"], "readonly");
            const store = transaction.objectStore("results");
            const request = store.get(id);
            
            request.onsuccess = function() {
                const result = request.result;
                
                // Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
                document.getElementById("patientName").value = result.patientName;
                document.getElementById("patientAge").value = result.patientAge;
                document.getElementById("patientGender").value = result.patientGender;
                document.getElementById("patientID").value = result.patientID;
                
                // Ù…Ø³Ø­ ØµÙÙˆÙ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                testsTableBody.innerHTML = '';
                
                // Ø¥Ø¶Ø§ÙØ© ØµÙÙˆÙ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                result.testsResults.forEach(test => {
                    addTestRow(test);
                });
                
                // ØªØ¹ÙŠÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                editingId = id;
                
                // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                patientForm.scrollIntoView({ behavior: 'smooth' });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                updateTotalAmount();
            };
            
            request.onerror = function(event) {
                showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†ØªÙŠØ¬Ø©: " + event.target.errorCode, "error");
            };
        }

        // Ø­Ø°Ù Ù†ØªÙŠØ¬Ø© Ù…Ø­ÙÙˆØ¸Ø©
        function deleteResult(id) {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªÙŠØ¬Ø©ØŸ")) {
                const transaction = db.transaction(["results"], "readwrite");
                const store = transaction.objectStore("results");
                const request = store.delete(id);
                
                request.onsuccess = function() {
                    showAlert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ù†Ø¬Ø§Ø­!", "success");
                    loadResults();
                };
                
                request.onerror = function(event) {
                    showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø©: " + event.target.errorCode, "error");
                };
            }
        }

        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        function viewResultDetails(id) {
            const transaction = db.transaction(["results"], "readonly");
            const store = transaction.objectStore("results");
            const request = store.get(id);
            
            request.onsuccess = function() {
                const result = request.result;
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø©
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop';
                document.body.appendChild(backdrop);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
                const detailsModal = document.createElement('div');
                detailsModal.className = 'details-modal';
                
                let detailsHTML = `
                    <h3>ØªÙØ§ØµÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±ÙŠØ¶: ${result.patientName}</h3>
                    <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù:</strong> ${result.patientID}</p>
                    <p><strong>Ø§Ù„Ø¹Ù…Ø±:</strong> ${result.patientAge}</p>
                    <p><strong>Ø§Ù„Ø¬Ù†Ø³:</strong> ${result.patientGender}</p>
                    <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„:</strong> ${formatDate(new Date(result.date))}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„ÙØ­Øµ</th>
                                <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©</th>
                                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                result.testsResults.forEach(test => {
                    detailsHTML += `
                        <tr>
                            <td>${test.testName}</td>
                            <td>${test.result}</td>
                            <td>${test.unit || ''}</td>
                            <td>${test.reference || ''}</td>
                            <td>${test.price ? test.price.toFixed(2) + ' Ø±ÙŠØ§Ù„' : ''}</td>
                            <td>${test.notes || ''}</td>
                        </tr>
                    `;
                });
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ (Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
                let totalAmount = result.totalAmount;
                if (totalAmount === undefined) {
                    totalAmount = 0;
                    result.testsResults.forEach(test => {
                        totalAmount += parseFloat(test.price || 0);
                    });
                }
                
                detailsHTML += `
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="4" style="text-align: left; font-weight: bold;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td>
                                <td class="total-amount">${totalAmount.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="printResultDetails(${result.id})" class="btn">Ø·Ø¨Ø§Ø¹Ø©</button>
                        <button onclick="closeModal()" class="btn">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                `;
                
                detailsModal.innerHTML = detailsHTML;
                document.body.appendChild(detailsModal);
            };
            
            request.onerror = function(event) {
                showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©: " + event.target.errorCode, "error");
            };
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function closeModal() {
            const backdrop = document.querySelector('.modal-backdrop');
            const modal = document.querySelector('.details-modal');
            
            if (backdrop) {
                document.body.removeChild(backdrop);
            }
            
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Ø·Ø¨Ø§Ø¹Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        function printResultDetails(id) {
            const transaction = db.transaction(["results"], "readonly");
            const store = transaction.objectStore("results");
            const request = store.get(id);
            
            request.onsuccess = function() {
                const result = request.result;
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø·Ø¨Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
                const printWindow = window.open('', '_blank');
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ (Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
                let totalAmount = result.totalAmount;
                if (totalAmount === undefined) {
                    totalAmount = 0;
                    result.testsResults.forEach(test => {
                        totalAmount += parseFloat(test.price || 0);
                    });
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ HTML Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
                let printContent = `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙ‚Ø±ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª - ${result.patientName}</title>
    <style>
        @page { size: A4; margin: 20mm; }
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            direction: rtl;
            background-color: #fff;
        }

        /* Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ø¹ Ø´Ø¹Ø§Ø±ÙŠÙ† */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header .logo {
            width: 100px;
        }

        .header .logo img {
            width: 100%;
            height: auto;
        }

        .header .institution-info {
            text-align: center;
            flex-grow: 1;
        }

        .header .institution-info h1 {
            margin: 0;
            color: #2563eb;
        }

        .header .institution-info p {
            margin: 2px 0;
            font-size: 0.9em;
            color: #374151;
        }

        /* Ø®Ø· ÙØ§ØµÙ„ Ø£ÙƒØ¨Ø± ÙˆØ£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ù‹Ø§ */
        hr.header-divider {
            border: 0;
            border-top: 3px solid #2563eb; /* Ø³Ù…Ùƒ Ø§Ù„Ø®Ø· Ø£ÙƒØ¨Ø± */
            margin: 15px 0 25px 0;
        }

        .patient-info {
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            padding: 10px;
            border-radius: 8px;
        }

        .patient-info h2 {
            text-align: center;
            margin-bottom: 10px;
            color: #2563eb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: right;
        }

        th {
            background-color: #f8fafc;
            font-weight: bold;
        }

        .total-row {
            font-weight: bold;
            background-color: #f0f9ff;
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.8em;
            color: #64748b;
        }

        @media print {
            .no-print { display: none; }
        }
    </style>
</head>
<body>

    <!-- Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ø¹ Ø´Ø¹Ø§Ø±ÙŠÙ† -->
    <div class="header">
        <div class="logo">
            <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„ÙŠØ³Ø§Ø±">
        </div>
        <div class="institution-info">
            <h1>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</h1>
            <p>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©ØŒ Ø§Ù„Ø¯ÙˆÙ„Ø©</p>
            <p>Ù‡Ø§ØªÙ: 0123456789 | Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: info@example.com</p>
      
        </div>
        <div class="logo">
            <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„ÙŠÙ…ÙŠÙ†">
        </div>
    </div>

    <!-- Ø®Ø· ÙØ§ØµÙ„ Ø£ÙƒØ¨Ø± -->
    <hr class="header-divider">

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ -->
    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ø¶ØºÙˆØ·Ø© ÙÙŠ Ø³Ø·Ø±ÙŠÙ† -->
<div class="patient-info">
    <h2 style="text-align:center;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</h2>
    <h3>
        <strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${result.patientName}
        </h3
    <p>
         
        <strong>Ø§Ù„Ø¹Ù…Ø±:</strong> ${result.patientAge} | 
        <strong>Ø§Ù„Ø¬Ù†Ø³:</strong> ${result.patientGender}
    </p>
    <p>
        <strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù:</strong> ${result.patientID} | 
        <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong> ${formatDate(new Date(result.date))}
    </p>
</div>

  
    <!-- Ø¬Ø¯ÙˆÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª -->
    <h2 style="text-align:center;">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª</h2>
    <table>
        <thead>
            <tr>
                <th>Ø§Ø³Ù… Ø§Ù„ÙØ­Øµ</th>
                <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©</th>
                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
        </thead>
        <tbody>
`;
 

                result.testsResults.forEach(test => {
                    printContent += `
                        <tr>
                            <td>${test.testName}</td>
                            <td>${test.result}</td>
                            <td>${test.unit || ''}</td>
                            <td>${test.reference || ''}</td>
                            <td>${test.price ? test.price.toFixed(2) + ' Ø±ÙŠØ§Ù„' : ''}</td>
                            <td>${test.notes || ''}</td>
                        </tr>
                    `;
                });
                
                printContent += `
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="4" style="text-align: left;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td>
                                    <td>${totalAmount.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div class="footer">
                            <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø±</p>
                            <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${formatDate(new Date())}</p>
                        </div>
                        
                        <div class="no-print" style="text-align: center; margin-top: 20px;">
                            <button onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                            <button onclick="window.close()">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </body>
                    </html>
                `;
                
                printWindow.document.open();
                printWindow.document.write(printContent);
                printWindow.document.close();
            };
            
            request.onerror = function(event) {
                showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: " + event.target.errorCode, "error");
            };
        }

        // ÙÙ„ØªØ±Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        function filterResults() {
            const patientFilter = document.getElementById('patientFilter').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            
            const rows = resultsTableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                // ØªØ¬Ø§Ù‡Ù„ ØµÙ "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø­ÙÙˆØ¸Ø©"
                if (row.cells.length === 1 && row.cells[0].getAttribute('colspan')) {
                    return;
                }
                
                const patientName = row.cells[0].textContent.toLowerCase();
                const dateCell = row.cells[6].textContent;
                
                let showRow = true;
                
                if (patientFilter && !patientName.includes(patientFilter)) {
                    showRow = false;
                }
                
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    const rowDate = parseRowDate(dateCell);
                    
                    if (filterDate.toDateString() !== rowDate.toDateString()) {
                        showRow = false;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        // ØªØ­Ù„ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙ
        function parseRowDate(dateString) {
            // ØªØ­ÙˆÙŠÙ„ ØªÙ†Ø³ÙŠÙ‚ "DD/MM/YYYY HH:MM" Ø¥Ù„Ù‰ Date object
            const parts = dateString.split(' ');
            const dateParts = parts[0].split('/');
            const timeParts = parts[1].split(':');
            
            return new Date(
                parseInt(dateParts[2]), // Ø³Ù†Ø©
                parseInt(dateParts[1]) - 1, // Ø´Ù‡Ø± (0-11)
                parseInt(dateParts[0]), // ÙŠÙˆÙ…
                parseInt(timeParts[0]), // Ø³Ø§Ø¹Ø©
                parseInt(timeParts[1]) // Ø¯Ù‚ÙŠÙ‚Ø©
            );
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø«
        function resetFilters() {
            document.getElementById('patientFilter').value = '';
            document.getElementById('dateFilter').value = '';
            filterResults();
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡
        function showAlert(message, type) {
            alertContainer.textContent = message;
            alertContainer.className = `alert alert-${type}`;
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            alertContainer.classList.remove("hidden");
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù
            setTimeout(() => {
                alertContainer.classList.add("hidden");
            }, 3000);
        }
    </script>
</body>
</html>
